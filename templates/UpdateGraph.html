<html lang="en">
<head>
  <meta charSet="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Line Plot with WebSocket & CSV</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
<div id="container">
  <canvas id="chart1"></canvas>
  <canvas id="chart2"></canvas>
</div>
<script>
  const ctx1 = document.getElementById('chart1').getContext('2d');
  const ctx2 = document.getElementById('chart2').getContext('2d');

  const data1 = {
    labels: [],
    datasets: [{
      label: 'Live Data',
      borderColor: 'rgba(75, 192, 192, 1)',
      backgroundColor: 'rgba(75, 192, 192, 0.2)',
      data: [],
      fill: true,
      tension: 0.1
    }]
  };

  const data2 = {
    labels: [],
    datasets: [{
      label: 'Live Data',
      borderColor: 'rgba(75, 192, 192, 1)',
      backgroundColor: 'rgba(75, 192, 192, 0.2)',
      data: [],
      fill: true,
      tension: 0.1
    }]
  };

  const config1 = {
    type: 'line',
    data: data1,
    options: {
      responsive: true,
      maintainAspectRatio: false,  // Allow canvas to fill its container
      scales: {
        x: {
          type: 'linear',
          position: 'bottom'
        },
        y: {
          beginAtZero: false
        }
      },
      animation: {
        duration: 0
      }
    }
  };

  const config2 = {
    type: 'line',
    data: data2,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'linear',
          position: 'bottom'
        },
        y: {
          beginAtZero: false
        }
      },
      animation: {
        duration: 0
      }
    }
  };

  const socket = io.connect("http://" + document.domain + ":" + location.port);
  const chart1 = new Chart(ctx1, config1);
  const chart2 = new Chart(ctx2, config2);

  socket.on('message', function (message) {
    const message_array = message.split(":");
    if (message_array[0] == "test1") {
      Papa.parse(message_array[1], {
        complete: function (results) {
          const parsedData = results.data;
          const validData = parsedData.filter(row => row.length >= 2 && !isNaN(row[1]));
          const newLabels = validData.map(row => row[0]);
          const newData = validData.map(row => row[1]);
          data1.labels = newLabels;
          data1.datasets[0].data = newData;
          chart1.update();
        }
      });
    } else {
      Papa.parse(message_array[1], {
        complete: function (results) {
          const parsedData = results.data;
          const validData = parsedData.filter(row => row.length >= 2 && !isNaN(row[1]));
          const newLabels = validData.map(row => row[0]);
          const newData = validData.map(row => row[1]);
          data2.labels = newLabels;
          data2.datasets[0].data = newData;
          chart2.update();
        }
      });
    }
  });

  socket.on("error", function (error) {
    console.error('WebSocket error: ', error);
  });

  socket.on("close", function (event) {
    console.log('WebSocket closed: ', event);
  });
</script>
</body>
</html>
