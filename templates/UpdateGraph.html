<html>
<head>

  <!-- Jquery -->
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossOrigin="anonymous"></script>

  <!-- Socket IO -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>

  <!-- Smooothie Charts -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.min.js"></script>

</head>
<body>
  <div id="chart-grid">
    <canvas id="tmp" width="500", height="100"></canvas>
  </div>
  <script type="text/javascript">

    // List of colors for charts
    const COLOR_LIST = [
      "#ff0000",
      "#ff6200",
      "#ffcc00",
      "#80ff00",
      "#00ff7b",
      "#00f2ff",
      "#0077ff",
      "#9000ff",
      "#e600ff",
      "#ff006a"
    ];

    // Global variables
    let firstMsgFlag = true;
    let chartMap = new Map();
    let seriesMap = new Map();

    // Setup socket connection for domain/port
    const socket = io.connect("http://" + document.domain + ":" + location.port);

    // On message from socket update time series with new data for source.
    socket.on('message', function(message) {

      // Split socket message into array of elements
      let splitMsg = message.split(":");

      // If first message... (clear flag)
      if (firstMsgFlag) {
        firstMsgFlag = false;

        // Iterate through sources in init msg
        splitMsg.forEach(function(sourceInfo) {

          // Extract source name and chart list from message array.
          let sourceInfoArray = sourceInfo.split(",");
          let sourceName = sourceInfoArray[0];
          let sourceChartList = sourceInfoArray.slice(1);

          // Create new time series for source and add it to map with name.
          let newSeries = new TimeSeries();
          seriesMap.set(sourceName, newSeries);

          // Iterate through list of chart for source
          sourceChartList.forEach(function (chartName) {

            // If cur chart does not exist...
            if (!chartMap.has(chartName)) {

              // Initialize new canvas for chart
              let newCanvas = document.createElement("canvas");
              newCanvas.width = "500";
              newCanvas.height = "100";
              document.getElementById("chart-grid").appendChild(newCanvas);

              // Initialize new smoothie chart and add it to map with name.
              let newChart = new SmoothieChart();
              chartMap.set(chartName, newChart);
            }

            // Find target chart from chartMap
            let targetChart = chartMap.get(chartName);

            // Find color not used in chart
            let seriesColor = COLOR_LIST[0];
            COLOR_LIST.forEach(function (cur_color) {
              if (targetChart.seriesSet.find((element) =>
                  element.options.strokeStyle === cur_color) !== undefined) {
                seriesColor = cur_color;
                return;
              }
            });

            // Add series to chart with color
            targetChart.addTimeSeries(newSeries);
            chartMap.get(chartName).streamTo(document.getElementById("tmp"), 1000);
          });
        });


      // If not first message...
      } else {

        // Parse message to get source name and new data.
        let sourceName = splitMsg[0];
        let sourceData = splitMsg[1].split(",");
        let sourceTime = parseFloat(sourceData[0]);
        let sourceValue = parseFloat(sourceData[1]);

        // Append new data to the source's series.
        seriesMap.get(sourceName).append(sourceTime, sourceValue);

        console.log(seriesMap.get(sourceName));

      }
    });

      // var random = new TimeSeries();
      // setInterval(function() {
      //   random.append(Date.now(), Math.random() * 10000);
      // }, 500);
      //
      // var chart = new SmoothieChart();
      // chart.addTimeSeries(random, { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
      // chart.streamTo(document.getElementById("chart"), 500);


    socket.on("error", function (error) {
      console.error('WebSocket error: ', error);
    });

    socket.on("close", function (event) {
      console.log('WebSocket closed: ', event);
    });

  </script>
  <style>
    /* TODO */
  </style>

</body>
</html>
